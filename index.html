<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party - Birlikte İzle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .setup-screen, .watch-screen {
            display: none;
        }

        .setup-screen.active, .watch-screen.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 20px;
            background: #000;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .controls button {
            flex: 1;
            min-width: 120px;
        }

        .room-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .room-code {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 2px;
        }

        .chat {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 14px;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .or-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .or-divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }

        .or-divider::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }

        .viewer-count {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }

        .secondary-btn {
            background: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Watch Party</h1>

        <div class="setup-screen active">
            <div class="input-group">
                <label>YouTube Video Linki</label>
                <input type="text" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." value="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
            </div>

            <button onclick="createRoom()">Oda Oluştur</button>

            <div class="or-divider">veya</div>

            <div class="input-group">
                <label>Oda Kodu</label>
                <input type="text" id="roomCode" placeholder="Örnek: ABC123">
            </div>

            <button onclick="joinRoom()">Odaya Katıl</button>
        </div>

        <div class="watch-screen">
            <div class="room-info">
                <div>Oda Kodu (arkadaşlarınla paylaş):</div>
                <div class="room-code" id="displayRoomCode">LOADING</div>
            </div>

            <div class="video-container" id="playerContainer">
                <div id="player"></div>
            </div>

            <div class="controls">
                <button onclick="syncPlay()">Oynat</button>
                <button onclick="syncPause()">Duraklat</button>
                <button onclick="syncRestart()">Başa Sar</button>
                <button onclick="leaveRoom()" class="secondary-btn">Odadan Çık</button>
            </div>

            <div class="viewer-count" id="viewerCount">İzleyenler: 0</div>

            <div class="status disconnected" id="connectionStatus">
                Bağlanıyor...
            </div>

            <div class="chat" id="chatBox">
                <div class="chat-message">Sohbet başlatıldı...</div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDaYJOPgAMLn2vD-khXOGA7oVd22RtzvMw",
            authDomain: "watchparty-12d55.firebaseapp.com",
            databaseURL: "https://watchparty-12d55-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "watchparty-12d55",
            storageBucket: "watchparty-12d55.firebasestorage.app",
            messagingSenderId: "551355494947",
            appId: "1:551355494947:web:17205c0efd91b16c547796"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let player;
        let currentRoom = null;
        let isHost = false;
        let syncLock = false;

        function onYouTubeIframeAPIReady() {
            console.log('YouTube API hazır');
        }

        function createRoom() {
            const videoUrl = document.getElementById('videoUrl').value;
            const videoId = extractVideoId(videoUrl);

            if (!videoId) {
                alert('Geçerli bir YouTube linki girin!');
                return;
            }

            currentRoom = generateRoomCode();
            isHost = true;

            database.ref('rooms/' + currentRoom).set({
                videoId: videoId,
                state: 'paused',
                time: 0,
                timestamp: Date.now(),
                viewers: 1
            });

            showWatchScreen(videoId);
            listenToRoom();
        }

        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase();

            if (!roomCode) {
                alert('Oda kodu girin!');
                return;
            }

            currentRoom = roomCode;
            isHost = false;

            database.ref('rooms/' + currentRoom).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    showWatchScreen(roomData.videoId);
                    listenToRoom();

     
                    database.ref('rooms/' + currentRoom + '/viewers').transaction((current) => {
                        return (current || 0) + 1;
                    });
                } else {
                    alert('Oda bulunamadı! Kod doğru mu?');
                }
            });
        }

        function showWatchScreen(videoId) {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.watch-screen').classList.add('active');
            document.getElementById('displayRoomCode').textContent = currentRoom;


            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'playsinline': 1,
                    'controls': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }


        function onPlayerReady(event) {
            updateStatus('Bağlandı', true);
            addChatMessage('Odaya başarıyla katıldınız');
        }


        function onPlayerStateChange(event) {
            if (syncLock) return;

            if (isHost) {
                const state = event.data === YT.PlayerState.PLAYING ? 'playing' : 'paused';
                const time = player.getCurrentTime();

                database.ref('rooms/' + currentRoom).update({
                    state: state,
                    time: time,
                    timestamp: Date.now()
                });
            }
        }


        function listenToRoom() {
            database.ref('rooms/' + currentRoom).on('value', (snapshot) => {
                if (!snapshot.exists()) return;

                const data = snapshot.val();


                document.getElementById('viewerCount').textContent = 'İzleyenler: ' + (data.viewers || 0);

                if (!isHost && player && player.seekTo) {
                    syncLock = true;

                    if (data.state === 'playing') {
                        const timeDiff = Math.abs(player.getCurrentTime() - data.time);
                        if (timeDiff > 2) {
                            player.seekTo(data.time, true);
                        }
                        if (player.getPlayerState() !== YT.PlayerState.PLAYING) {
                            player.playVideo();
                        }
                    } else {
                        if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                            player.pauseVideo();
                        }
                    }

                    setTimeout(() => { syncLock = false; }, 500);
                }
            });
        }


        function syncPlay() {
            if (!player) return;
            player.playVideo();

            if (isHost) {
                database.ref('rooms/' + currentRoom).update({
                    state: 'playing',
                    time: player.getCurrentTime(),
                    timestamp: Date.now()
                });
            }
        }


        function syncPause() {
            if (!player) return;
            player.pauseVideo();

            if (isHost) {
                database.ref('rooms/' + currentRoom).update({
                    state: 'paused',
                    time: player.getCurrentTime(),
                    timestamp: Date.now()
                });
            }
        }


        function syncRestart() {
            if (!player) return;
            player.seekTo(0);

            if (isHost) {
                database.ref('rooms/' + currentRoom).update({
                    time: 0,
                    timestamp: Date.now()
                });
            }
        }


        function leaveRoom() {
            if (currentRoom) {
                database.ref('rooms/' + currentRoom + '/viewers').transaction((current) => {
                    return Math.max((current || 1) - 1, 0);
                });
                database.ref('rooms/' + currentRoom).off();
            }

            location.reload();
        }


        function extractVideoId(url) {
            const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
            return match ? match[1] : null;
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function updateStatus(message, connected) {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.className = 'status ' + (connected ? 'connected' : 'disconnected');
        }

        function addChatMessage(message) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.textContent = message;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        window.addEventListener('beforeunload', () => {
            if (currentRoom) {
                database.ref('rooms/' + currentRoom + '/viewers').transaction((current) => {
                    return Math.max((current || 1) - 1, 0);
                });
            }
        });
    </script>
</body>
</html>
